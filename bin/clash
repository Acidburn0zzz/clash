#! /usr/bin/env ruby

$LOAD_PATH.unshift(File.expand_path("../lib", File.dirname(__FILE__)))

require 'clash'
require 'optparse'

options = {}

banner = <<-BANNER
clash #{Clash::VERSION} -- Clash is a diff based testing suite for static sites.

Usage:

  clash [path] [tests] [options]

  To run only specific tests, pass test numbers separated by commas.

    $ clash test   # Compare files in the 'test' directory
    $ clash 1      # Run only the first test
    $ clash 2,3    # Run the second and third tests
    $ clash 2-4    # Run the second, third, and fourth tests
    $ clash test 1 # Run the first test in the 'test' directory.

Options:

BANNER

config_info = <<-CONFIG

Configuration:

  Clash reads its configuration from a .clash.yml file in the root of your project. Use the --file
  option to choose a different configuration file.

  View the README or visit https://github.com/imathis/clash for configuration info.

CONFIG

OptionParser.new do |opts|
  opts.banner = banner

  opts.on("-f FILE", "--file FILE", "Use a specific test file (default: [PATH]/.clash.yml)") do |f|
    options[:file] = f
  end

  opts.on("-c", "--context NUMBER", Integer, "On diff errors, show NUMBER of lines of surrounding context (default: 2)") do |context|
    options[:context] = context
  end

  opts.on("-h", "--help", "Show this message") do |h|
    puts opts
    puts config_info
    options[:help] = h
  end

end.parse!

unless ARGV.empty?
  # Parse input `clash 1 2 3` and `clash 1,2,3` and `clash 1-3` the same
  #
  options[:path] = ARGV.shift if ARGV.first =~ /\D+/
  options[:only] = Clash::Helpers.expand_list_of_numbers ARGV
end

unless options[:help]
  tests = Clash::Tests.new(options)
  tests.run
end
